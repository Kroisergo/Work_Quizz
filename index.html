<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz com IA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --primary:#3b82f6; --success:#10b981; --danger:#ef4444;
      --card:#0b1220; --border:rgba(255,255,255,0.08); --input:#0b1220; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html.light{ --bg:#f5f7fb; --text:#0b1220; --muted:#4b5563; --card:#ffffff; --border:rgba(0,0,0,0.12); --input:#ffffff; --shadow:0 8px 20px rgba(0,0,0,.08) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% -100px, rgba(59,130,246,.08), transparent 60%),
                     radial-gradient(1000px 600px at -10% -40px, rgba(16,185,129,.06), transparent 60%), var(--bg);
         color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#8b5cf6);display:grid;place-items:center;box-shadow:var(--shadow)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1f2937,#0b1220);color:var(--text);
      padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:linear-gradient(180deg,#3b82f6,#1d4ed8);border-color:#1d4ed8;color:#fff}
    .btn.success{background:linear-gradient(180deg,#10b981,#059669);border-color:#047857;color:#fff}
    .btn.ghost{background:transparent}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309);border-color:#b45309;color:#fff}
    .row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .row2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    input,select,textarea{background:var(--input);border:1px solid var(--border);border-radius:10px;padding:12px;color:var(--text)}
    textarea{min-height:110px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    .hero{padding:24px;border:1px solid var(--border);border-radius:var(--radius);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));box-shadow:var(--shadow)}
    .hero h1{margin:0 0 8px;font-size:30px}
    .hero-actions{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:14px}
    .metric{font-size:28px;font-weight:800;margin:0}
    .wizard{margin-top:20px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .wizard-steps{display:flex;gap:10px;align-items:center;padding:12px 14px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--border)}
    .step{display:flex;gap:8px;align-items:center;font-weight:600}
    .step .dot{width:24px;height:24px;border-radius:9999px;display:grid;place-items:center;border:1px solid var(--border);background:rgba(255,255,255,.04)}
    .step.active .dot{background:linear-gradient(180deg,var(--primary),#1d4ed8);border-color:#1d4ed8;color:#fff}
    .step.done .dot{background:linear-gradient(180deg,#10b981,#047857);border-color:#047857;color:#fff}
    .wizard-body{padding:20px}
    .q-list{display:grid;gap:12px}
    .q-card{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#0b1220,#0a1020);padding:14px}
    html.light .q-card{background:#fff}
    .q-card h4{margin:0 0 10px}
    .q-card img{max-width:100%;border-radius:10px;border:1px solid var(--border);margin:10px 0}
    .choices{display:grid;gap:8px;margin-top:8px}
    .choice{border:1px solid var(--border);padding:10px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,.02)}
    .choice.correct{border-color:rgba(16,185,129,.7)}
    .choice.wrong{border-color:rgba(239,68,68,.7)}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .config-panel{position:fixed;top:70px;right:28px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow);width:240px;display:none;z-index:20}
    .config-panel h4{margin:0 0 8px}
    .footer{margin:22px 0;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){ .row,.row2,.grid{grid-template-columns:1fr} .hero h1{font-size:24px} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">üéì</div>
        <div>
          <div style="font-weight:800;letter-spacing:-.01em">Quiz com IA</div>
          <div class="muted" style="font-size:12px;margin-top:2px">Gerador autom√°tico em PT-PT</div>
        </div>
      </div>
      <nav>
        <button class="btn ghost" id="homeBtn">In√≠cio</button>
        <button class="btn ghost" id="createBtn">Criar</button>
        <button class="btn ghost" id="savedBtn">Meus Quizzes</button>
        <button class="btn" id="configBtn">Config</button>
      </nav>
    </header>

    <div id="configPanel" class="config-panel">
      <h4>Configura√ß√µes</h4>
      <label><input type="radio" name="theme" value="dark"> Modo escuro</label>
      <label><input type="radio" name="theme" value="light"> Modo claro</label>
    </div>

    <section class="hero" id="home">
      <h1>Crie quizzes a partir de um tema</h1>
      <p class="muted">Introduza um tema e a IA gera automaticamente perguntas de avalia√ß√£o em portugu√™s de Portugal.</p>
      <div class="hero-actions">
        <button class="btn primary" id="startNew">+ Criar novo quiz</button>
      </div>
      <div class="grid">
        <div class="card"><div class="metric" id="statQuizzes">0</div><div class="muted">Guardados</div></div>
        <div class="card"><div class="metric" id="statQuestions">0</div><div class="muted">Perguntas guardadas</div></div>
        <div class="card"><div class="metric" id="statPlayed">0</div><div class="muted">Jogos conclu√≠dos</div></div>
      </div>
    </section>

    <section class="wizard" id="wizard" style="display:none">
      <div class="wizard-steps">
        <div class="step active" id="s1"><div class="dot">1</div> Informa√ß√µes</div>
        <div class="step" id="s2"><div class="dot">2</div> Perguntas</div>
        <div class="step" id="s3"><div class="dot">3</div> Revis√£o</div>
      </div>
      <div class="wizard-body">
        <div id="step1">
          <div class="row">
            <div>
              <label>T√≠tulo *</label>
              <input id="quizTitle" placeholder="Digite o t√≠tulo do quiz"/>
            </div>
            <div>
              <label>Disciplina</label>
              <input id="quizSubject" placeholder="Ex.: Hist√≥ria, Ci√™ncias, Matem√°tica"/>
            </div>
            <div>
              <label>N√≠vel/Ano</label>
              <input id="quizLevel" placeholder="Ex.: 7.¬∫ ano, Secund√°rio, Licenciatura"/>
            </div>
          </div>
          <div class="row2" style="margin-top:10px">
            <div>
              <label>Tema *</label>
              <input id="topicInput" placeholder="Ex.: Sistema Solar, Revolu√ß√£o Francesa..."/>
            </div>
            <div>
              <label>N.¬∫ de perguntas</label>
              <select id="qnt">
                <option>3</option><option selected>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              </select>
            </div>
          </div>
          <div class="row2" style="margin-top:10px">
            <div>
              <label>Tipo</label>
              <select id="qType">
                <option value="mc">M√∫ltipla Escolha</option>
                <option value="fill">Preencher Espa√ßo</option>
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <label><input type="checkbox" id="withImages"> Gerar imagem ilustrativa</label>
            </div>
          </div>
          <div class="actions">
            <button class="btn" id="toStep2">Guardar & Continuar</button>
          </div>
        </div>

        <div id="step2" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <strong>Gerar perguntas com IA</strong>
            <div class="muted" style="margin:6px 0">Usa Pollinations (sem chave), com retentativas e proxies autom√°ticos.</div>
            <div class="actions">
              <button class="btn primary" id="genBtn">Gerar com IA</button>
              <button class="btn" id="addManual">Adicionar manualmente</button>
            </div>
          </div>

          <div class="q-list" id="qList"></div>

          <div class="actions">
            <button class="btn" id="back1">Anterior</button>
            <button class="btn success" id="toStep3">Revisar</button>
          </div>
        </div>

        <div id="step3" style="display:none">
          <div class="card">
            <strong>Revis√£o do quiz</strong>
            <div class="muted" style="margin-top:6px">Experimente realizar o quiz abaixo.</div>
          </div>
          <div id="playArea" style="margin-top:14px"></div>
          <div class="actions">
            <button class="btn" id="back2">Anterior</button>
            <button class="btn success" id="finishBtn">Concluir & Guardar</button>
          </div>
        </div>
      </div>
    </section>

    <section id="savedSection" style="display:none">
      <div class="card">
        <strong>Meus Quizzes</strong>
        <div class="muted" style="margin-top:6px">Guardados no teu navegador (localStorage).</div>
      </div>
      <div id="savedList"></div>
      <div class="actions">
        <button class="btn" id="backHome">Voltar ao In√≠cio</button>
        <button class="btn warn" id="clearAll">Apagar todos</button>
      </div>
    </section>

    <div class="footer">Prot√≥tipo acad√©mico ‚Äî IA generativa (Pollinations c/ proxies). Public√°vel em Vercel/Netlify.</div>
  </div>

<script>
const $ = s=>document.querySelector(s)
const $$ = s=>document.querySelectorAll(s)
const el = (tag,props={})=>{const e=document.createElement(tag);Object.assign(e,props);return e}

const themeRadios = ()=>$$('input[name="theme"]')
const loadTheme = ()=> localStorage.getItem('quiz_theme') || 'dark'
const applyTheme = t => { document.documentElement.classList.toggle('light', t==='light'); localStorage.setItem('quiz_theme',t); themeRadios().forEach(r=>r.checked=(r.value===t)) }

const state = {
  quizzes: loadSaved(),
  current: { title:'', subject:'', level:'', topic:'', type:'mc', n:5, withImages:false, questions:[] },
  played: parseInt(localStorage.getItem('quiz_played')||'0',10)
}

function saveAll(){ localStorage.setItem('quizzes_saved', JSON.stringify(state.quizzes)) }
function loadSaved(){ try{ return JSON.parse(localStorage.getItem('quizzes_saved')||'[]') }catch{return[]} }

function updateStats(){
  const totalQ = state.quizzes.reduce((s,q)=> s+(q.questions?.length||0), 0)
  $('#statQuizzes').innerText = String(state.quizzes.length)
  $('#statQuestions').innerText = String(totalQ)
  $('#statPlayed').innerText = String(state.played)
}

$('#homeBtn').onclick = ()=>{ showHome() }
$('#createBtn').onclick = ()=>{ startWizard() }
$('#savedBtn').onclick = ()=>{ showSaved() }
$('#startNew').onclick = ()=>{ startWizard() }
$('#backHome').onclick = ()=>{ showHome() }
$('#clearAll').onclick = ()=>{ if(confirm('Apagar todos os quizzes guardados?')){ state.quizzes=[]; saveAll(); renderSaved(); updateStats() } }

$('#configBtn').onclick = ()=>{ const p = $('#configPanel'); p.style.display = (p.style.display==='block')? 'none':'block' }
themeRadios().forEach(r=> r.addEventListener('change', ()=> applyTheme(r.value)))
applyTheme(loadTheme())

function showHome(){ $('#home').style.display='block'; $('#wizard').style.display='none'; $('#savedSection').style.display='none'; updateStats() }
function startWizard(){ $('#home').style.display='none'; $('#savedSection').style.display='none'; $('#wizard').style.display='block'; setStep(1) }
function showSaved(){ $('#home').style.display='none'; $('#wizard').style.display='none'; $('#savedSection').style.display='block'; renderSaved() }

function setStep(n){
  ['s1','s2','s3'].forEach((id,i)=>{ const e=document.getElementById(id); e.classList.remove('active','done'); if(i+1<n) e.classList.add('done'); else if(i+1===n) e.classList.add('active') })
  $('#step1').style.display = n===1?'block':'none'
  $('#step2').style.display = n===2?'block':'none'
  $('#step3').style.display = n===3?'block':'none'
}

$('#toStep2').onclick = ()=>{
  state.current.title = $('#quizTitle').value.trim() || 'Quiz'
  state.current.subject = $('#quizSubject').value.trim()
  state.current.level = $('#quizLevel').value.trim()
  state.current.topic = $('#topicInput').value.trim()
  state.current.n = parseInt($('#qnt').value,10)
  state.current.type = $('#qType').value
  state.current.withImages = $('#withImages').checked
  if(!state.current.topic){ alert('Indica um tema.'); return }
  setStep(2)
}

$('#back1').onclick = ()=> setStep(1)
$('#back2').onclick = ()=> setStep(2)
$('#toStep3').onclick = ()=>{ if(state.current.questions.length===0){ alert('Ainda n√£o tens perguntas. Gera ou adiciona uma.'); return } renderPlayable(); setStep(3) }
$('#finishBtn').onclick = ()=>{
  const saved = JSON.parse(JSON.stringify(state.current))
  saved.createdAt = new Date().toISOString()
  state.quizzes.unshift(saved)
  saveAll()
  updateStats()
  showHome()
  alert('Quiz guardado!')
}

$('#addManual').onclick = ()=>{
  const q = state.current.type==='mc'
    ? {type:'mc', prompt:'', options:['Op√ß√£o 1','Op√ß√£o 2','Op√ß√£o 3'], answer:0, image:null}
    : {type:'fill', prompt:'Escreve a frase com ___', options:[], answer:'', image:null}
  state.current.questions.push(q); renderQuestions()
}

$('#genBtn').onclick = ()=> generateQuestions()

function renderQuestions(){
  const host = $('#qList'); host.innerHTML=''
  if(state.current.questions.length===0){ host.innerHTML='<div class="muted">Nenhuma pergunta adicionada ainda.</div>'; return }
  state.current.questions.forEach((q,idx)=>{
    const card = el('div',{className:'q-card'})
    card.appendChild(el('h4',{innerText:`${idx+1}. ${q.prompt || '(sem enunciado)'}`}))
    if(q.image){ card.appendChild(el('img',{src:q.image,alt:'Imagem'})) }
    const t = el('textarea',{value:q.prompt,placeholder:'Enunciado da pergunta...'})
    t.oninput = e=>{ q.prompt = e.target.value }
    card.appendChild(t)
    if(q.type==='mc'){
      const wrap = el('div',{className:'choices'})
      if(!Array.isArray(q.options)||q.options.length===0) q.options=['Op√ß√£o 1','Op√ß√£o 2','Op√ß√£o 3']
      q.options = q.options.slice(0,4)
      while(q.options.length<3) q.options.push('Nova op√ß√£o')
      q.options.forEach((opt,i)=>{
        const row = el('div',{className:'row2'})
        const inp = el('input',{value:opt})
        inp.oninput = e=>{ q.options[i]=e.target.value }
        const radio = el('input',{type:'radio',name:'ans'+idx,checked:(i===q.answer)})
        radio.onchange = ()=>{ q.answer=i }
        row.appendChild(inp); row.appendChild(radio); wrap.appendChild(row)
      })
      const add = el('button',{className:'btn',innerText:'Adicionar op√ß√£o'})
      add.onclick=()=>{ if(q.options.length<4){ q.options.push('Nova op√ß√£o'); renderQuestions() } else alert('M√°ximo 4 op√ß√µes.') }
      card.appendChild(wrap); card.appendChild(add)
    } else {
      const info = el('div',{className:'muted',innerText:'Usa "___" no enunciado. A resposta correta abaixo:'})
      const ans = el('input',{value:q.answer||'',placeholder:'Resposta correta'})
      ans.oninput = e=>{ q.answer=e.target.value }
      card.appendChild(info); card.appendChild(ans)
    }
    const bar = el('div',{className:'actions'})
    const del = el('button',{className:'btn',innerText:'Remover'})
    del.onclick = ()=>{ state.current.questions.splice(idx,1); renderQuestions() }
    bar.appendChild(del); card.appendChild(bar)
    host.appendChild(card)
  })
}

function renderPlayable(){
  const host = $('#playArea'); host.innerHTML=''
  let score=0
  state.current.questions.forEach((q,idx)=>{
    const card = el('div',{className:'q-card'})
    card.appendChild(el('h4',{innerText:`${idx+1}. ${q.prompt}`}))
    if(q.image){ card.appendChild(el('img',{src:q.image,alt:'Ilustra√ß√£o'})) }
    if(q.type==='mc'){
      const wrap = el('div',{className:'choices'})
      q.options.forEach((opt,i)=>{
        const ch = el('div',{className:'choice',innerText:opt})
        ch.onclick = ()=>{
          if(ch.dataset.answered) return
          ch.dataset.answered=true
          if(i===q.answer){ ch.classList.add('correct'); score++ } else { ch.classList.add('wrong') }
        }
        wrap.appendChild(ch)
      })
      const sol = el('div',{className:'muted',innerText:`Correta: ${q.options[q.answer]}`})
      card.appendChild(wrap); card.appendChild(sol)
    } else {
      const inp = el('input',{placeholder:'Resposta‚Ä¶'})
      const btn = el('button',{className:'btn',innerText:'Validar'})
      const res = el('div',{className:'muted'})
      btn.onclick = ()=>{
        const ok = (inp.value||'').trim().toLowerCase() === String(q.answer||'').trim().toLowerCase()
        res.innerText = ok? 'Correto!' : `Incorreto. Resposta: ${q.answer}`
        if(ok) score++; btn.disabled=true
      }
      const row = el('div',{className:'actions'}); row.appendChild(inp); row.appendChild(btn)
      card.appendChild(row); card.appendChild(res)
    }
    host.appendChild(card)
  })
  const end = el('div',{className:'card',style:'margin-top:12px'})
  const btn = el('button',{className:'btn success',innerText:'Finalizar e ver pontua√ß√£o'})
  btn.onclick = ()=>{ const total=state.current.questions.length; alert(`Pontua√ß√£o: ${score}/${total}`); state.played++; localStorage.setItem('quiz_played',String(state.played)); updateStats() }
  end.appendChild(btn); host.appendChild(end)
}

function renderSaved(){
  const list = $('#savedList'); list.innerHTML=''
  if(state.quizzes.length===0){ list.innerHTML='<div class="card muted">Ainda n√£o tens quizzes guardados.</div>'; return }
  state.quizzes.forEach((q,idx)=>{
    const c = el('div',{className:'card'})
    const h = el('div',{style:'display:flex;justify-content:space-between;align-items:center;gap:10px'})
    const left = el('div',{innerHTML:`<strong>${q.title||'Quiz'}</strong><div class="muted">${q.topic} ‚Ä¢ ${q.questions?.length||0} perguntas</div>`})
    const play = el('button',{className:'btn',innerText:'Abrir'})
    const del = el('button',{className:'btn',innerText:'Apagar'})
    play.onclick = ()=>{
      state.current = JSON.parse(JSON.stringify(q))
      startWizard(); setStep(3); renderPlayable()
    }
    del.onclick = ()=>{
      if(confirm('Apagar este quiz?')){ state.quizzes.splice(idx,1); saveAll(); renderSaved(); updateStats() }
    }
    h.appendChild(left); h.appendChild(play); h.appendChild(del)
    c.appendChild(h); list.appendChild(c)
  })
}

function imgFromTopic(topic){
  const mode = document.documentElement.classList.contains('light')? 'fundo claro' : 'fundo escuro'
  return `https://image.pollinations.ai/prompt/${encodeURIComponent(`${topic}, ilustra√ß√£o educativa, diagrama simples, ${mode}`)}?aspect=16:9`
}

async function generateQuestions(){
  const topic = state.current.topic
  const n = state.current.n
  const type = state.current.type
  const wantImages = state.current.withImages
  try{
    const data = await getQuestionsViaAI({topic,n,type,wantImages})
    if(!data || !Array.isArray(data.questions) || data.questions.length===0) throw new Error('Sem perguntas')
    const normalized = normalizeQuestions(data.questions, {topic, type, wantImages})
    state.current.questions = normalized
    renderQuestions()
  }catch(e){
    alert('N√£o foi poss√≠vel gerar perguntas neste momento. Tenta novamente em alguns segundos.')
    console.error(e)
  }
}

function normalizeQuestions(arr, {topic,type,wantImages}){
  return arr.slice(0,50).map(q=>{
    const isMC = (q.type||type)==='mc'
    let options = Array.isArray(q.options)? q.options.filter(o=>String(o||'').trim()!=='') : []
    if(isMC){
      if(options.length<3){ while(options.length<3) options.push('Op√ß√£o') }
      if(options.length>4) options = options.slice(0,4)
      let answer = typeof q.answer==='number'? q.answer : parseInt(q.answer,10)
      if(Number.isNaN(answer) || answer<0 || answer>=options.length) answer = 0
      return { type:'mc', prompt:String(q.prompt||`${topic}: pergunta`), options, answer, image: wantImages? (q.image||imgFromTopic(topic)) : null }
    }else{
      const ans = String(q.answer||'').trim() || 'Resposta'
      const prompt = String(q.prompt||`${topic}: Complete a frase ‚Äî ___`)
      return { type:'fill', prompt, options:[], answer:ans, image: wantImages? (q.image||imgFromTopic(topic)) : null }
    }
  }).slice(0, Math.max(3, Math.min(10, state.current.n)))
}

async function getQuestionsViaAI({ topic, n, type, wantImages }) {
  const prompt = `
Gera um JSON ESTRITO em portugu√™s de Portugal com este formato...
  `;

  const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": "Bearer A_TUA_CHAVE_AQUI",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [{ role: "user", content: prompt }]
    })
  });

  const text = await res.text();
  const match = text.match(/\{[\s\S]*\}/);
  return JSON.parse(match[0]);
}




function systemPrompt(topic,n,type,wantImages){
  const img = wantImages ? 'A propriedade "image" pode ser null ou URL.' : 'A propriedade "image" deve ser null.'
  return `Gera um JSON ESTRITO em portugu√™s de Portugal com este esquema:
{
  "questions": [
    ${type==='mc'
      ? '{"type":"mc","prompt":"texto","options":["A","B","C"],"answer":0,"image": null}'
      : '{"type":"fill","prompt":"frase com ___","options":[],"answer":"resposta","image": null}'
    }
  ]
}
Regras:
- Tema: ${topic}
- N√∫mero de perguntas: ${n} (entre 3 e 10)
- Tipo: ${type === 'mc' ? 'm√∫ltipla escolha' : 'preencher espa√ßo (usa ___ no enunciado)'}
- Portugu√™s de Portugal (ortografia e vocabul√°rio PT-PT)
- Em m√∫ltipla escolha, devolve 3 ou 4 op√ß√µes e "answer" √© o √≠ndice correto (0-based)
- N√£o escrevas nada fora do JSON. ${img}`
}

async function fetchWithTimeout(url,{timeout=10000}={}){
  const ctrl = new AbortController()
  const id = setTimeout(()=>ctrl.abort(), timeout)
  const res = await fetch(url,{signal:ctrl.signal})
  clearTimeout(id)
  if(!res.ok) throw new Error('HTTP '+res.status)
  return await res.text()
}

function extractJSON(text){
  try{ return JSON.parse(text) }catch{}
  const codeBlocks = text.match(/```[\s\S]*?```/g)
  if(codeBlocks){
    for(const block of codeBlocks){
      const cleaned = block.replace(/```(json|[\w-]+)?/g,'').replace(/```/g,'').trim()
      try{ return JSON.parse(cleaned) }catch{}
    }
  }
  const match = text.match(/\{[\s\S]*\}/)
  if(match){ try{ return JSON.parse(match[0]) }catch{} }
  return null
}

showHome()
updateStats()
</script>
</body>
</html>
